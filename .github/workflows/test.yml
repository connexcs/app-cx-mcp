name: MCP Test Suite

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:   # allow manual trigger from the Actions tab

jobs:
  test:
    name: Run masterTest via cx run
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Install the ConnexCS cx CLI
      # -----------------------------------------------------------------------
      - name: Install cx CLI
        run: npm install -g cx-tools

      # -----------------------------------------------------------------------
      # Write .env from GitHub secrets so cx CLI can authenticate
      # cx uses: CX_REFRESH_TOKEN (auth), APP_ID (which ScriptForge app to target)
      # MCP server code uses: API_USERNAME
      # -----------------------------------------------------------------------
      - name: Configure cx credentials
        run: |
          cat > .env <<EOF
          API_USERNAME=${{ secrets.API_USERNAME }}
          CX_REFRESH_TOKEN=${{ secrets.CX_REFRESH_TOKEN }}
          APP_ID=${{ secrets.APP_ID }}
          EOF

      # -----------------------------------------------------------------------
      # Run the master test suite
      # -----------------------------------------------------------------------
      - name: Run master test suite
        id: run_tests
        run: |
          echo "Running cx run masterTest..."
          OUTPUT=$(cx run masterTest 2>&1)
          echo "$OUTPUT"

          # Capture output for subsequent steps
          echo "test_output<<ENDOFOUTPUT" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "ENDOFOUTPUT" >> $GITHUB_OUTPUT

          # Fail the step if the output contains a failure indicator
          if echo "$OUTPUT" | grep -qE "(FAIL|ERROR|tests failed|0/[0-9]+ tests passed)"; then
            echo "result=fail" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "result=pass" >> $GITHUB_OUTPUT
          fi
        env:
          API_USERNAME: ${{ secrets.API_USERNAME }}
          CX_REFRESH_TOKEN: ${{ secrets.CX_REFRESH_TOKEN }}
          APP_ID: ${{ secrets.APP_ID }}

      # -----------------------------------------------------------------------
      # Post a summary to the Actions run summary page
      # -----------------------------------------------------------------------
      - name: Write job summary
        if: always()
        run: |
          echo "## MCP Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.run_tests.outputs.test_output }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.run_tests.outputs.result }}" = "pass" ]; then
            echo "### ✅ All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ One or more tests failed" >> $GITHUB_STEP_SUMMARY
          fi

      # -----------------------------------------------------------------------
      # Comment test results on the PR
      # -----------------------------------------------------------------------
      - name: Comment results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.run_tests.outputs.test_output }}`;
            const passed = "${{ steps.run_tests.outputs.result }}" === "pass";
            const icon = passed ? "✅" : "❌";
            const headline = passed ? "All tests passed" : "One or more tests failed";

            const body = [
              `## ${icon} MCP Test Suite — ${headline}`,
              "",
              "```",
              output,
              "```",
              "",
              `> Triggered by commit ${context.sha.slice(0, 7)} on \`${context.ref}\``
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
